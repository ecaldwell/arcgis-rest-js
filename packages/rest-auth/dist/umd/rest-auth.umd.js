!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@esri/rest-request")):"function"==typeof define&&define.amd?define(["exports","@esri/rest-request"],r):r(e.EsriRestAuth={},e.EsriRestRequest)}(this,function(e,r){"use strict";function t(e,t){return r.request(e,t).then(function(e){var r={token:e.access_token,username:e.username,expires:new Date(Date.now()+(60*e.expires_in*1e3-6e4))};return e.refresh_token&&(r.refreshToken=e.refresh_token),r})}function n(e,t){return"undefined"!=typeof window&&window.location&&window.location.host?t.referer=window.location.host:t.referer="@esri.rest-auth",r.request(e,t)}function o(){var e={promise:null,resolve:null,reject:null};return e.promise=new Promise(function(r,t){e.resolve=r,e.reject=t}),e}var i=function(){function e(e){this.clientId=e.clientId,this.clientSecret=e.clientSecret,this.token=e.token,this.expires=e.expires,this.portal="https://www.arcgis.com/sharing/rest",this.duration=e.duration||20160}return e.prototype.getToken=function(e){return this.token&&this.expires&&this.expires.getTime()>Date.now()?Promise.resolve(this.token):this.refreshToken()},e.prototype.refreshToken=function(){var e=this;return t(this.portal+"/oauth2/token/",{client_id:this.clientId,client_secret:this.clientSecret,grant_type:"client_credentials"}).then(function(r){return e.token=r.token,e.expires=r.expires,r.token})},e.prototype.refreshSession=function(){var e=this;return this.refreshToken().then(function(){return e})},e}(),s=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++){r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},h=function(){function e(e){this.clientId=e.clientId,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this.username=e.username,this.password=e.password,this._token=e.token,this._tokenExpires=e.tokenExpires,this.portal=e.portal||"https://www.arcgis.com/sharing/rest",this.tokenDuration=e.tokenDuration||20160,this.redirectUri=e.redirectUri,this.refreshTokenDuration=e.refreshTokenDuration||20160,this.trustedServers={}}return Object.defineProperty(e.prototype,"token",{get:function(){return this._token},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tokenExpires",{get:function(){return this._tokenExpires},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this._refreshToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshTokenExpires",{get:function(){return this._refreshTokenExpires},enumerable:!0,configurable:!0}),e.beginOAuth2=function(r,t){void 0===t&&(t=window);var n=s({portal:"https://arcgis.com/sharing/rest",duration:20160,popup:!0},r),i=n.portal,h=n.clientId,a=n.duration,u=n.redirectUri,p=n.popup,c=i+"/oauth2/authorize?client_id="+h+"&response_type=token&expiration="+a+"&redirect_uri="+encodeURIComponent(u);if(p){var f=o();return t["__ESRI_REST_AUTH_HANDLER_"+h]=function(r,t){r?f.reject(r):f.resolve(new e({clientId:h,portal:i,token:t.token,tokenExpires:t.expires,username:t.username}))},t.open(c,"oauth-window","height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes"),f.promise}t.location.href=c},e.completeOAuth2=function(t,n){function o(r,t){if(n.opener&&n.opener.parent)return n.opener.parent["__ESRI_REST_AUTH_HANDLER_"+a](r,t),void n.close();if(n.parent)return n.parent["__ESRI_REST_AUTH_HANDLER_"+a](r,t),void n.close();if(r)throw r;return new e({clientId:a,portal:h,token:t.token,tokenExpires:t.expires,username:t.username})}void 0===n&&(n=window);var i=s({portal:"https://arcgis.com/sharing/rest",duration:20160},t),h=i.portal,a=i.clientId,u=(i.duration,i.redirectUri,n.location.href.match(/access_token=(.+)&expires_in=(.+)&username=(.+)/));if(!u){var p=n.location.href.match(/error=(.+)&error_description=(.+)/),c=p[1],f=decodeURIComponent(p[2]);return o(new r.ArcGISRequestError(f,c),null)}return o(null,{token:u[1],expires:new Date(Date.now()+1e3*parseInt(u[2],10)-6e4),username:u[3]})},e.authorize=function(e,r){var t=s({portal:"https://arcgis.com/sharing/rest",duration:20160},e),n=t.portal,o=t.clientId,i=t.duration,h=t.redirectUri;r.writeHead(301,{Location:n+"/oauth2/authorize?client_id="+o+"&duration="+i+"&response_type=code&redirect_uri="+encodeURIComponent(h)}),r.end()},e.exchangeAuthorizationCode=function(r,n){var o=s({portal:"https://www.arcgis.com/sharing/rest",duration:20160},r),i=o.portal,h=o.clientId,a=o.duration,u=o.redirectUri;return t(i+"/oauth2/token",{grant_type:"authorization_code",client_id:h,redirect_uri:u,code:n}).then(function(r){return new e({clientId:h,portal:i,redirectUri:u,refreshToken:r.refreshToken,refreshTokenDuration:a,refreshTokenExpires:new Date(Date.now()+1e3*(a-60)),token:r.token,tokenExpires:r.expires,username:r.username})})},e.deserialize=function(r){var t=JSON.parse(r);return new e({clientId:t.clientId,refreshToken:t.refreshToken,refreshTokenExpires:new Date(t.refreshTokenExpires),username:t.username,password:t.password,token:t.token,tokenExpires:new Date(t.tokenExpires),portal:t.portal,tokenDuration:t.tokenDuration,redirectUri:t.redirectUri,refreshTokenDuration:t.refreshTokenDuration})},e.prototype.getToken=function(e){return"https://www.arcgis.com/sharing/rest"===this.portal&&/^https?:\/\/\S+\.arcgis\.com.+/.test(e)?this.getFreshToken():new RegExp(this.portal).test(e)?this.getFreshToken():this.getTokenForServer(e)},e.prototype.toJSON=function(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires,portal:this.portal,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,refreshTokenDuration:this.refreshTokenDuration}},e.prototype.serialize=function(){return JSON.stringify(this)},e.prototype.refreshSession=function(){return this.username&&this.password?this.refreshWithUsernameAndPassword():this.clientId&&this.refreshToken?this.refreshWithRefreshToken():Promise.reject(new Error("Unable to refresh token."))},e.prototype.getTokenForServer=function(e){var t=this,o=e.split("/rest/services/")[0],i=this.trustedServers[o];return i&&i.expires.getTime()>Date.now()?Promise.resolve(i.token):r.request(o+"/rest/info").then(function(e){return e.owningSystemUrl}).then(function(n){if(!new RegExp(n).test(t.portal))throw new r.ArcGISAuthError(e+" is not federated with "+t.portal+".","NOT_FEDERATED");return r.request(n+"/sharing/rest/info")}).then(function(e){return e.authInfo.tokenServicesUrl}).then(function(r){return n(r,{token:t.token,serverUrl:e,expiration:t.tokenDuration})}).then(function(e){return t.trustedServers[o]={expires:new Date(e.expires),token:e.token},e.token})},e.prototype.getFreshToken=function(){return this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()?Promise.resolve(this.token):this.refreshSession().then(function(e){return e.token})},e.prototype.refreshWithUsernameAndPassword=function(){var e=this;return n(this.portal+"/generateToken",{username:this.username,password:this.password,expiration:this.tokenDuration}).then(function(r){return e._token=r.token,e._tokenExpires=new Date(r.expires),e})},e.prototype.refreshWithRefreshToken=function(){var e=this;return this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()<Date.now()?this.refreshRefreshToken():t(this.portal+"/oauth2/token",{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}).then(function(r){return e._token=r.token,e._tokenExpires=r.expires,e})},e.prototype.refreshRefreshToken=function(){var e=this;return t(this.portal+"/oauth2/token",{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}).then(function(r){return e._token=r.token,e._tokenExpires=r.expires,e._refreshToken=r.refreshToken,e._refreshTokenExpires=new Date(Date.now()+60*(e.refreshTokenDuration-1)*1e3),e})},e}();e.ApplicationSession=i,e.UserSession=h,e.fetchToken=t,e.generateToken=n,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=rest-auth.umd.js.map
